pipeline {
    agent any
    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
    }
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Configure and Verify AWS CLI') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'awscredss', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                    script {
                        // Using bash for better compatibility
                        sh '''
                        #!/bin/bash

                        echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-'not set'}"
                        echo "AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-'not set'}"

                        # Check if the credentials are set
                        if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
                            echo "ERROR: AWS credentials are not set."
                            currentBuild.result = 'FAILURE'
                            error("AWS credentials are not set.")
                        fi

                        # Configure AWS CLI
                        aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
                        aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
                        aws configure set default.region "$AWS_DEFAULT_REGION"
                        aws configure list

                        # Verify AWS CLI configuration
                        aws sts get-caller-identity
                        '''
                    }
                }
            }
        }
    }
}
