pipeline {
    agent any
    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
    }
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Configure and Verify AWS CLI') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'awscredss', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                    script {
                        // Adding script block for better handling
                        sh '''
                        echo "AWS Access Key ID: ${AWS_ACCESS_KEY_ID}..."
                        echo "AWS Secret Access Key: ${AWS_SECRET_ACCESS_KEY}..."

                        # Check if the credentials are set
                        if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
                            echo "ERROR: AWS credentials are not set."
                            exit 1
                        fi

                        # Configure AWS CLI
                        aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                        aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                        aws configure set default.region $AWS_DEFAULT_REGION
                        aws configure list

                        # Verify AWS CLI configuration
                        aws sts get-caller-identity
                        '''
                    }
                }
            }
        }
    }
}
